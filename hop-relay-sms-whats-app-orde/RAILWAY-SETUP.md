# Railway Deployment Guide for HopRelay Shopify App

## Prerequisites
- Railway account (https://railway.app)
- GitHub repository connected
- Shopify Partner account

## Step 1: Create Railway Project

1. Go to https://railway.app/new
2. Click "Deploy from GitHub repo"
3. Select your repository: `TaimoorSiddiquiOfficial/HopRelayShopify`
4. Railway will auto-detect the Dockerfile

## Step 2: Add PostgreSQL Database

1. In your Railway project dashboard, click "New"
2. Select "Database" → "Add PostgreSQL"
3. Railway will automatically create a `DATABASE_URL` environment variable

## Step 3: Configure Environment Variables

Go to your service → Variables tab and add the following:

### Shopify Configuration
```
SHOPIFY_API_KEY=2ba8e6117cba33bf73b057cb11b169db
SHOPIFY_API_SECRET=<get_from_partners_shopify_com>
SHOPIFY_APP_URL=${{RAILWAY_PUBLIC_DOMAIN}}
SCOPES=read_orders,read_customers
```

### HopRelay API Configuration
```
HOPRELAY_ADMIN_BASE_URL=https://hoprelay.com/admin
HOPRELAY_API_BASE_URL=https://hoprelay.com/api
```

### HopRelay Authentication Tokens
**CRITICAL: All three tokens are required for different endpoints**

```
# Admin API Token - For /admin endpoints
HOPRELAY_ADMIN_API_TOKEN=b9dfcbb971107f6a6742858ae2865e76f0f97641421972f30b03d3f9e565bd01

# System Token - For system-level operations
HOPRELAY_SYSTEM_TOKEN=515f2c5deead70eb5cfa4e4d6a63b536e3c61fd3148bccd72b24985ca236acc8

# SSO Plugin Token - For SSO dashboard login
HOPRELAY_SSO_PLUGIN_TOKEN=40ca899844a5fd8d0a8a16947ca3e0932debb2cf59f5bccdeb97d815f2e41707
```

### HopRelay Defaults
```
HOPRELAY_DEFAULT_COUNTRY=PK
HOPRELAY_DEFAULT_TIMEZONE=Asia/Karachi
HOPRELAY_DEFAULT_LANGUAGE_ID=1
HOPRELAY_DEFAULT_ROLE_ID=1
```

### Email Configuration (SMTP via Hostinger)
```
EMAIL_SERVICE=smtp
SMTP_HOST=smtp.hostinger.com
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=info@hoprelay.com
SMTP_PASS=<your_smtp_password>
```

### Node Environment
```
NODE_ENV=production
PORT=3000
```

### Database (Auto-generated by Railway PostgreSQL)
```
DATABASE_URL=${{Postgres.DATABASE_URL}}
```
*Note: This is automatically linked when you add PostgreSQL database*

## Step 4: Configure Service Settings

1. **Settings Tab:**
   - Service Name: `hoprelay-shopify-app`
   - Branch: `main` or `production-setup`
   - Build Command: (Leave empty - uses Dockerfile)
   - Start Command: `npm run docker-start`
   
2. **Networking Tab:**
   - Enable "Public Networking"
   - Generate a domain or add custom domain
   - Note the generated URL (e.g., `hoprelay-shopify-app.up.railway.app`)

3. **Health Checks:**
   - Path: `/`
   - Timeout: 100 seconds
   - Restart Policy: On Failure
   - Max Retries: 10

## Step 5: Update Shopify App Settings

1. Go to Shopify Partners dashboard
2. Select your app
3. Update the following URLs with your Railway domain:
   - App URL: `https://your-app.up.railway.app`
   - Allowed redirection URLs: `https://your-app.up.railway.app/auth/callback`

## Step 6: Deploy

1. Railway will automatically deploy when you push to your branch
2. Monitor deployment logs in Railway dashboard
3. Check for successful database migrations
4. Verify health check is passing

## Step 7: Database Migrations

Railway will automatically run migrations on deployment via the `docker-start` script:
```bash
npm run setup  # Runs: prisma generate && prisma migrate deploy
npm run start  # Starts the application
```

## Railway-Specific Features

### Auto-scaling
- Railway automatically scales based on traffic
- Configure scaling in Settings → Resources

### Environment Management
- Use Railway's PR environments for testing
- Create separate projects for staging/production

### Monitoring
- View logs: Service → Deployments → Select deployment
- Metrics: Service → Metrics tab
- Database metrics: PostgreSQL service → Metrics

### Custom Domain (Optional)
1. Go to Settings → Networking
2. Click "Add Custom Domain"
3. Follow DNS configuration instructions

## Troubleshooting

### Database Connection Issues
- Verify `DATABASE_URL` is properly linked
- Check PostgreSQL service is running
- Review connection string format

### Build Failures
- Check Dockerfile syntax
- Verify all dependencies in package.json
- Review build logs in Railway dashboard

### App Not Starting
- Check environment variables are set
- Verify PORT is set to 3000
- Review application logs

### Prisma Migration Issues
```bash
# Connect to Railway shell
railway shell

# Run migrations manually
npx prisma migrate deploy
npx prisma generate
```

## Useful Railway CLI Commands

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login to Railway
railway login

# Link to your project
railway link

# View logs
railway logs

# Run commands in Railway environment
railway run <command>

# Open Railway dashboard
railway open
```

## Cost Estimation

**Starter Plan (Free Trial):**
- $5/month credit
- 512 MB RAM
- 1 GB Disk
- Shared CPU

**Developer Plan:**
- $20/month
- 8 GB RAM
- 100 GB Disk
- Shared CPU

**PostgreSQL:**
- Included in plan usage
- Scales with disk usage

## Security Best Practices

1. **Never commit sensitive tokens:**
   - Use Railway environment variables
   - Rotate tokens regularly

2. **Use different tokens for environments:**
   - Separate staging/production tokens
   - Configure per-project variables

3. **Enable 2FA:**
   - Secure your Railway account
   - Limit team access

4. **Monitor logs:**
   - Check for unauthorized access
   - Set up alerts for errors

## Next Steps

1. Set up staging environment
2. Configure custom domain
3. Set up monitoring/alerts
4. Enable automatic backups for PostgreSQL
5. Configure CI/CD for automated testing

## Support

- Railway Docs: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Shopify App Development: https://shopify.dev
